{% sw_extends '@Storefront/storefront/page/account/index.html.twig' %}

{% block page_account_main_content %}
    <div class="account-content">
        <div class="account-content-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>{{ "tcg.decks.detail.title"|trans }}</h1>
                    <p class="account-content-description">
                        {{ "tcg.decks.detail.description"|trans }}
                    </p>
                </div>
                <div>
                    <a href="{{ path('frontend.account.tcg.decks') }}" class="btn btn-outline-secondary">
                        {{ "tcg.common.back"|trans }}
                    </a>
                </div>
            </div>
        </div>

        <div class="account-content-main">
            <div class="deck-detail-loading" id="deckLoading">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">{{ "tcg.common.loading"|trans }}</span>
                    </div>
                    <p class="mt-2">{{ "tcg.decks.loading"|trans }}</p>
                </div>
            </div>

            <div class="deck-detail-content" id="deckContent" style="display: none;">
                <!-- Deck Info -->
                <div class="deck-info-card mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h2 class="deck-name" id="deckName"></h2>
                                    <p class="deck-description text-muted" id="deckDescription"></p>
                                    <div class="deck-meta">
                                        <span class="badge badge-info" id="deckFormat"></span>
                                        <span class="badge badge-success" id="deckStatus"></span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-right">
                                    <div class="deck-stats">
                                        <div class="stat-item">
                                            <span class="stat-value" id="totalCards">0</span>
                                            <span class="stat-label">{{ "tcg.decks.total_cards"|trans }}</span>
                                        </div>
                                    </div>
                                    <div class="deck-actions mt-3">
                                        <button class="btn btn-primary btn-sm" onclick="editDeck()">
                                            {{ "tcg.common.edit"|trans }}
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="addCard()">
                                            {{ "tcg.cards.add_to_deck"|trans }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards Grid -->
                <div class="deck-cards">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>{{ "tcg.decks.cards_in_deck"|trans }}</h3>
                        <div class="deck-filters">
                            <input type="text" class="form-control form-control-sm"
                                   placeholder="{{ "tcg.cards.search_placeholder"|trans }}"
                                   id="cardSearch" onkeyup="filterCards()">
                        </div>
                    </div>

                    <div class="cards-grid" id="cardsGrid">
                        <!-- Cards will be loaded here -->
                    </div>

                    <div class="cards-empty" id="cardsEmpty" style="display: none;">
                        <div class="alert alert-info text-center">
                            <h4>{{ "tcg.decks.no_cards.title"|trans }}</h4>
                            <p>{{ "tcg.decks.no_cards.description"|trans }}</p>
                            <button class="btn btn-primary" onclick="addCard()">
                                {{ "tcg.cards.add_first_card"|trans }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="deck-detail-error" id="deckError" style="display: none;">
                <div class="alert alert-danger">
                    <h4>{{ "tcg.common.error"|trans }}</h4>
                    <p id="errorMessage"></p>
                    <a href="{{ path('frontend.account.tcg.decks') }}" class="btn btn-secondary">
                        {{ "tcg.common.back_to_decks"|trans }}
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block page_account_sidebar_content %}
    {% sw_include '@TcgManager/storefront/page/account/sidebar.html.twig' %}
{% endblock %}

{% block base_body_script %}
    {{ parent() }}

    <script>
        const deckId = '{{ deckId }}';
        let deckData = null;
        let cardsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadDeckDetails();
        });

        function loadDeckDetails() {
            console.log('Loading deck details for ID:', deckId);

            fetch(`/account/tcg/decks/${deckId}/api`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'  // Include cookies/session
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    deckData = data.data;
                    displayDeckInfo();
                    loadDeckCards();
                } else {
                    console.error('API error:', data.message);
                    showError(data.message || '{{ "tcg.decks.load_error"|trans }}');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showError('{{ "tcg.general.unknown_error"|trans }}: ' + error.message);
            });
        }

        function displayDeckInfo() {
            document.getElementById('deckName').textContent = deckData.name;
            document.getElementById('deckDescription').textContent = deckData.description || '';
            document.getElementById('deckFormat').textContent = deckData.format || 'Standard';
            document.getElementById('deckStatus').textContent = deckData.isPublic ? 'Public' : 'Private';
        }

        function loadDeckCards() {
            // For now, show empty state
            document.getElementById('totalCards').textContent = '0';
            document.getElementById('deckLoading').style.display = 'none';
            document.getElementById('deckContent').style.display = 'block';
            document.getElementById('cardsEmpty').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('deckLoading').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('deckError').style.display = 'block';
        }

        function editDeck() {
            alert('{{ "tcg.decks.edit_coming_soon"|trans }}');
        }

        function addCard() {
            alert('{{ "tcg.cards.add_coming_soon"|trans }}');
        }

        function filterCards() {
            // TODO: Implement card filtering
        }
    </script>

    <style>
        .deck-info-card .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .deck-stats .stat-item {
            text-align: center;
        }

        .deck-stats .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .deck-stats .stat-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .deck-filters {
            width: 250px;
        }

        @media (max-width: 768px) {
            .deck-filters {
                width: 100%;
                margin-top: 1rem;
            }

            .d-flex.justify-content-between {
                flex-direction: column;
            }
        }
    </style>
{% endblock %}
